{% extends "base.html" %}

{% block content %}
    <h3>Select Update Category</h3>
     <select id='update-select' class="form-control">
       {% for model in models %}
         <option>{{ model }}</option>
       {% endfor %}
     </select>
     <div id='update_area' class='container'>
        <div id='update_action' >
        <a class="btn btn-primary" onclick='add_entry()'>
            <i class="icon-plus-sign icon-white"></i>
            Add
        </a>
        </div>
     </div>
{% endblock content %}
{% block tail_script %}
<script>
var uInfo = {};
var model_name = "";

$(document).ready(function() {
    $('#update-select').change(function(){
    	process_selection();
    });
    process_selection();
} );

function add_entry(){
	var data = {service_name: model_name};
	addRowDT2(model_name,{},uInfo.fields,data,uInfo.order,false,'update-table');
}

function process_selection(){
	var opt = $('#update-select option:selected').text();
	get_update_info(opt);
	model_name = opt.toLowerCase();
}

function edit_row(rowId, modName){
	editRow(rowId,{},uInfo.fields);
}

function save_row(rowId, modName){
	var data = {service_name: 'rest/'+model_name+"/"+rowId+"/"};
    saveRowDT2(rowId,{},uInfo.fields,data,uInfo.order,model_name,'update-table');
}

function adjust_data(inData){
	var retData = {};
	retData[model_name] = {key:inData['id']};
	for (var i=0;i<uInfo.order.length;i++){
		retData[model_name][uInfo.order[i]] = inData[uInfo.order[i]];
	}
	return retData;
}

function del_row(rowId, model_name){
	
}

function add_table(update_info){
	    uInfo = update_info;
		if (d3.select('[id="update-table"]').empty() == false){
			d3.select('[id="update-table_wrapper"]').remove();
		}
		var tbl = d3.select('[id="update_area"]').append('table');
		tbl.attr('id','update-table');
		tbl.attr('class','table table-sm table-bordered');
		var row = tbl.append('thead').append('tr');
		for (var i=0;i<update_info.order.length;i++){
			row.append('th').text(update_info.order[i]);
		}
		row.append('th').text(" -- action -- ");
		$('#update-table').DataTable( {"scrollY":"600px","scrollCollapse": true,"paging":false} );
}

function add_data(data_arr, update_info){
	var dt = $('#update-table').dataTable();
	for (var j=0;j<data_arr.length;j++){
		var element = data_arr[j];
		var dt_row = [];
		for (var i=0;i<update_info.order.length;i++){
			var field = update_info.order[i];
			var value = "";
			if (element.hasOwnProperty(field)){
				value = element[field];
			}
			dt_row.push(value);
		}
		dt_row.push(""); // for the action column
		var addid = dt.fnAddData(dt_row);
		var row = dt.fnGetNodes(addid);
		$(row).attr('id',element['key']);
		var children = $(row).children();
		for (var i=0;i<children.length;i++){
			var child = children[i];
			if (i < update_info.order.length){
				$(child).attr('id',element['key']+"_"+update_info.order[i]);	
			} else {
				// action column
				var cellId = element['key'] + "_buttons";
				$(child).attr('id',cellId);
				add_buttons(element['key'], model_name, d3.select('[id="'+cellId+'"]'));
			}
			
		}
	}
	//dt.draw();
}

function get_model_data(update_name,update_info){
	$.ajax({
		url:"/rest/"+update_name.toLowerCase(),
		dataType: "json",
		success: function(data){
			console.log(data);
			add_data(data.list[update_name.toLowerCase()],update_info);
		},
		error: function(data){
			console.log(data);
		}
	});
}

function get_update_info(update_name){
	$.ajax({
		//type: "GET",
		url: "/update_info/"+update_name,
		dataType: "json",
		success: function(data){
			if (data.status == 'success'){
				console.log(data.payload);
				add_table(data.payload);
				get_model_data(update_name,data.payload);
			}else{
				alert(data.message);
			}

	     },
	     error: function(data){
		        console.log(data.responseText);
		        //alert(json.error);},
		    },
		    failure: function(data){
		        console.log(data.responseText);
		        //alert(json.error);
		        }
	})
}
</script>
{% endblock tail_script %}
